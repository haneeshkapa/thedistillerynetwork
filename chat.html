<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Jonathan - Distillation Expert</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 70vh;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #8b5a2b, #cd853f);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
        
        .chat-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .chat-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .user-message {
            align-self: flex-end;
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            align-self: flex-start;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }
        
        .bot-message.thinking {
            font-style: italic;
            opacity: 0.7;
        }
        
        .input-area {
            display: flex;
            padding: 20px;
            gap: 10px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            border-color: #007bff;
        }
        
        .send-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
            min-width: 80px;
        }
        
        .send-btn:hover {
            background: #0056b3;
        }
        
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                height: 80vh;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¥ƒ Jonathan's Distillation Expertise</h1>
        <p>Ask me anything about alcohol distillation, copper stills, and the craft!</p>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h2>Chat with Jonathan</h2>
            <p>American Copper Works - Distillation Expert</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                Hello! I'm Jonathan from American Copper Works. I'm passionate about the art and science of distillation. 
                Whether you're curious about mash bills, cuts, copper stills, or any aspect of distilling, I'm here to help! 
                What would you like to know?
            </div>
        </div>
        
        <div class="input-area">
            <input 
                type="text" 
                class="message-input" 
                id="messageInput" 
                placeholder="Ask about distillation, stills, fermentation..."
                maxlength="1000"
            >
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        
        <div class="status" id="status">Ready to chat</div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');
        
        // Generate a session ID for this chat session
        const sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function setStatus(text) {
            status.textContent = text;
        }
        
        function setThinking(thinking = false) {
            sendBtn.disabled = thinking;
            sendBtn.textContent = thinking ? 'Thinking...' : 'Send';
            setStatus(thinking ? 'Jonathan is thinking...' : 'Ready to chat');
        }
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, true);
            messageInput.value = '';
            setThinking(true);
            
            try {
                const response = await fetch('/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: sessionId || '+15551234567', // Use sessionId as phone or default
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.reply) {
                    addMessage(data.reply);
                } else if (data.error) {
                    addMessage(`Sorry, I encountered an error: ${data.error}`);
                } else {
                    addMessage("Sorry, I didn't receive a proper response. Please try again.");
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessage(`Sorry, I'm having trouble connecting right now. Please try again in a moment. (${error.message})`);
            } finally {
                setThinking(false);
                messageInput.focus();
            }
        }
        
        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Focus input on load
        messageInput.focus();
        
        // Set initial status
        setStatus(`Session: ${sessionId.substr(0, 20)}...`);
    </script>
</body>
</html>